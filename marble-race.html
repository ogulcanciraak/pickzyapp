<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plinko Kaosu - Arcade Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600;700&family=Righteous&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Fredoka', sans-serif; 
            background-color: #050b14;
            background-image: 
                radial-gradient(circle at 50% 0%, #1e1b4b 0%, transparent 60%),
                radial-gradient(circle at 80% 80%, #312e81 0%, transparent 40%);
        }
        
        .font-arcade { font-family: 'Righteous', cursive; letter-spacing: 1px; }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(99, 102, 241, 0.3); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(99, 102, 241, 0.6); }

        /* Neon Glow Effects */
        .neon-border {
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.2), inset 0 0 20px rgba(99, 102, 241, 0.1);
        }
        .machine-frame {
            box-shadow: 
                0 0 0 4px #1e293b, /* Inner Bezel */
                0 0 0 8px #312e81, /* Outer Rim */
                0 20px 50px -10px rgba(79, 70, 229, 0.5); /* Ambient Glow */
        }

        /* Animations */
        @keyframes slideIn {
            0% { transform: translateX(10px); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }
        .animate-slideIn { animation: slideIn 0.3s ease-out forwards; }
        
        @keyframes popIn {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-popIn { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 15px rgba(244, 63, 94, 0.4); }
            50% { box-shadow: 0 0 25px rgba(244, 63, 94, 0.7); }
        }
        .animate-pulse-glow { animation: pulse-glow 2s infinite; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 overflow-hidden text-slate-200 selection:bg-indigo-500 selection:text-white">

    <div id="setupView" class="w-full max-w-md bg-slate-900/80 backdrop-blur-xl rounded-[2rem] shadow-2xl overflow-hidden border border-white/10 flex flex-col h-[85vh] transition-all duration-300 relative z-20">
        <div class="bg-gradient-to-b from-white/5 to-transparent p-6 border-b border-white/5 flex justify-between items-center">
            <h1 class="text-2xl font-arcade text-white tracking-wide flex items-center gap-3 drop-shadow-md">
                <div class="bg-indigo-600 p-2 rounded-lg shadow-lg shadow-indigo-500/40">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><circle cx="12" cy="12" r="10"/><path d="m16 12-4-4-4 4"/><path d="M12 16V8"/></svg>
                </div>
                PLINKO <span class="text-indigo-400">KAOSU</span>
            </h1>
            <button onclick="location.href='index.html'" class="text-xs font-bold text-slate-400 hover:text-white transition-colors bg-white/5 hover:bg-white/10 px-3 py-1.5 rounded-full border border-white/5 flex items-center gap-1">
    <span>üè†</span> ANA SAYFA
</button>
        </div>

        <div class="p-6 flex flex-col gap-6">
            <div class="relative group">
                <div class="absolute -inset-0.5 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl opacity-30 group-hover:opacity-70 transition duration-300 blur"></div>
                <div class="relative flex gap-2 bg-slate-900 rounded-xl p-1">
                    <input type="text" id="racerInput" placeholder="Yarƒ±≈ümacƒ± Adƒ±..." class="flex-1 bg-transparent px-4 py-3 focus:outline-none text-white font-bold placeholder-slate-500" maxlength="12">
                    <button onclick="addRacer()" class="bg-indigo-600 hover:bg-indigo-500 text-white p-3 rounded-lg transition-colors shadow-lg active:scale-95">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    </button>
                </div>
            </div>

            <div class="bg-white/5 p-1 rounded-xl border border-white/5">
                <select id="gameMode" class="w-full bg-slate-800 text-white font-bold text-sm focus:outline-none cursor-pointer p-3 rounded-lg border border-slate-700 hover:border-indigo-500 transition-colors">
                    <option value="first">ü•á ALTIN GOL (ƒ∞lk Biten Kazanƒ±r)</option>
                    <option value="top3">ü•â ƒ∞LK 3 (Podyum Belirlensin)</option>
                    <option value="all">üèÅ TAM KAOS (Herkes Beklensin)</option>
                </select>
            </div>
        </div>

        <div class="px-6 pb-2 flex justify-between items-center text-xs font-bold text-slate-500 uppercase tracking-wider">
            <span>Yarƒ±≈ümacƒ± Listesi</span>
            <span id="countBadge" class="bg-white/5 px-2 py-0.5 rounded text-slate-300">0/30</span>
        </div>

        <div id="racersList" class="flex-1 overflow-y-auto px-6 pb-4 space-y-2 custom-scrollbar"></div>

        <div class="p-6 bg-gradient-to-t from-slate-900 via-slate-900 to-transparent">
            <button id="startBtn" onclick="startRace()" disabled class="w-full relative group overflow-hidden bg-indigo-600 text-white py-4 rounded-xl font-arcade text-xl tracking-widest shadow-2xl shadow-indigo-900/50 disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none transition-all">
                <span class="absolute inset-0 w-full h-full bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full group-hover:animate-[shimmer_1.5s_infinite]"></span>
                <span class="relative flex items-center justify-center gap-3">
                    BA≈ûLAT <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                </span>
            </button>
        </div>
    </div>

    <div id="gameContainer" class="hidden w-full max-w-5xl h-[90vh] gap-6 relative z-10 items-stretch">
        
        <div class="flex-1 relative bg-slate-900 rounded-3xl machine-frame overflow-hidden flex flex-col">
            
            <div class="h-14 bg-slate-800 border-b border-slate-700 flex justify-between items-center px-6 shrink-0 relative z-20 shadow-md">
                <div class="flex items-center gap-2">
                    <div class="w-2.5 h-2.5 bg-red-500 rounded-full animate-pulse shadow-[0_0_10px_red]"></div>
                    <span class="text-xs font-bold text-slate-300 tracking-widest uppercase">CANLI YARI≈û</span>
                </div>
                
                <button onclick="stopRace()" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-1.5 rounded-lg text-xs font-bold border border-slate-600 transition-all flex items-center gap-2 group">
                    <svg class="group-hover:-translate-x-0.5 transition-transform" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M11 17l-5-5 5-5"/><path d="M18 17l-5-5 5-5"/></svg>
                    D√úZENLE
                </button>
            </div>

            <div class="flex-1 relative bg-[#0f172a] shadow-inner">
                <div class="absolute inset-0 opacity-10" style="background-image: radial-gradient(#6366f1 1px, transparent 1px); background-size: 20px 20px;"></div>
                <canvas id="raceCanvas" class="block w-full h-full relative z-10 touch-none"></canvas>
            </div>
        </div>

        <div class="w-72 hidden md:flex flex-col shrink-0">
            <div class="bg-slate-800/60 backdrop-blur-md border border-white/10 rounded-3xl overflow-hidden flex flex-col h-full shadow-2xl">
                <div class="p-5 bg-white/5 border-b border-white/5">
                    <h2 class="text-indigo-400 font-arcade tracking-widest text-lg text-center drop-shadow-sm">
                        SIRALAMA
                    </h2>
                </div>
                
                <div id="liveLeaderboard" class="flex-1 overflow-y-auto p-3 space-y-2 custom-scrollbar transition-all">
                    </div>

                <div class="p-3 border-t border-white/5 text-center">
                    <span class="text-[10px] text-slate-500 font-mono">PLINKO SYSTEM v2.5 - LIVE</span>
                </div>
            </div>
        </div>

    </div>

    <div id="mobileLeaderboard" class="md:hidden hidden fixed bottom-4 left-4 right-4 z-30 bg-slate-900/90 backdrop-blur-xl border border-white/10 rounded-2xl p-3 shadow-2xl overflow-x-auto whitespace-nowrap">
        <div id="mobileLeaderboardContent" class="flex gap-3"></div>
    </div>

    <div id="resultModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/90 backdrop-blur-md transition-all duration-300 opacity-0 px-4">
        <div class="bg-slate-800 rounded-3xl p-1 max-w-sm w-full shadow-2xl transform scale-95 transition-all duration-300 neon-border">
            <div class="bg-slate-900 rounded-[1.4rem] p-8 text-center overflow-hidden relative">
                <div class="absolute inset-0 bg-[conic-gradient(at_top,_var(--tw-gradient-stops))] from-indigo-900/40 via-slate-900 to-slate-900 animate-spin-slow"></div>
                
                <div class="relative z-10">
                    <div class="inline-block mb-4 p-4 rounded-full bg-yellow-500/10 border border-yellow-500/20 shadow-[0_0_30px_rgba(234,179,8,0.2)] animate-pulse-glow">
                        <svg class="w-16 h-16 text-yellow-400 drop-shadow-md" viewBox="0 0 24 24" fill="currentColor"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
                    </div>

                    <h2 class="text-sm font-bold text-slate-400 mb-1 tracking-widest uppercase">KAZANAN</h2>
                    <div id="winnerText" class="text-4xl font-arcade text-white mb-8 truncate px-2 drop-shadow-[0_0_10px_rgba(255,255,255,0.5)]"></div>

                    <div class="flex flex-col gap-3">
                        <button onclick="startRace()" class="w-full py-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold transition-all shadow-lg active:scale-95 flex items-center justify-center gap-2 group">
                            <svg class="group-hover:rotate-180 transition-transform duration-500" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                            TEKRAR OYNA
                        </button>
                        <button onclick="stopRace()" class="w-full py-4 bg-slate-800 hover:bg-slate-700 text-slate-300 hover:text-white rounded-xl font-bold transition-all shadow-lg active:scale-95 flex items-center justify-center gap-2">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M11 17l-5-5 5-5"/><path d="M18 17l-5-5 5-5"/></svg>
                            D√úZENLE
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG & PHYSICS ---
        const COLORS = ['#ef4444', '#f97316', '#f59e0b', '#84cc16', '#10b981', '#06b6d4', '#3b82f6', '#8b5cf6', '#d946ef', '#f43f5e', '#6366f1', '#ec4899'];
        
        // Fƒ∞Zƒ∞K AYARLARI
        const GRAVITY = 0.12;      
        const FRICTION = 0.99;     
        const BOUNCE = 0.5;        
        const MARBLE_RADIUS = 7;   // 14px √áap
        const PEG_RADIUS = 3;      // 6px √áap
        const WALL_THICKNESS = 20; 
        
        let TRACK_WIDTH = 0; 
        let TRACK_HEIGHT = 0;

        // State
        let racers = [];
        let marbles = [];
        let obstacles = [];
        let animationId;
        let isRacing = false;
        let finishOrder = [];
        let selectedMode = 'first';
        let lidOpen = false;

        const canvas = document.getElementById('raceCanvas');
        const ctx = canvas.getContext('2d');

        // --- LOCAL STORAGE ---
        function loadRacers() {
            const saved = localStorage.getItem('marble_racers');
            if (saved) {
                racers = JSON.parse(saved);
                updateRacerList();
            } else {
                ['Mavi', 'Kƒ±rmƒ±zƒ±', 'Ye≈üil', 'Sarƒ±'].forEach(name => {
                    racers.push({ name, color: COLORS[racers.length % COLORS.length] });
                });
                updateRacerList();
            }
        }
        function saveRacers() { localStorage.setItem('marble_racers', JSON.stringify(racers)); }

        // --- UI FUNCTIONS ---
        function updateRacerList() {
            const list = document.getElementById('racersList');
            const count = document.getElementById('countBadge');
            const btn = document.getElementById('startBtn');
            
            list.innerHTML = racers.map((r, i) => `
                <div class="flex items-center bg-white/5 p-3 rounded-xl border border-white/5 hover:bg-white/10 transition-colors group animate-popIn">
                    <div class="w-8 h-8 rounded-full border-2 border-white/10 shadow-inner flex items-center justify-center text-white text-xs font-bold mr-3 shrink-0" style="background:${r.color}; box-shadow: 0 0 10px ${r.color}40;">${i + 1}</div>
                    <span class="font-bold text-slate-200 flex-1 truncate">${r.name}</span>
                    <button onclick="removeRacer(${i})" class="text-slate-500 hover:text-red-400 p-2 transition-colors opacity-0 group-hover:opacity-100">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>
                    </button>
                </div>
            `).join('');
            
            count.innerText = `${racers.length}/30`;
            btn.disabled = racers.length < 2;
        }

        function addRacer() {
            const input = document.getElementById('racerInput');
            const name = input.value.trim();
            if (!name) return;
            if (racers.length >= 30) return alert('Maksimum 30 yarƒ±≈ü√ßƒ±!');
            racers.push({ name, color: COLORS[racers.length % COLORS.length] });
            input.value = '';
            saveRacers();
            updateRacerList();
        }

        function removeRacer(index) {
            racers.splice(index, 1);
            saveRacers();
            updateRacerList();
        }

        document.getElementById('racerInput').addEventListener('keypress', e => e.key === 'Enter' && addRacer());

        // --- MAP GENERATION (√áAPRAZ DAƒûILIM G√úNCELLEMESƒ∞) ---
        function generateMap() {
            obstacles = [];
            
            const centerX = TRACK_WIDTH / 2;
            const gateW = 160; 
            const gateH = 100;
            const gateTopY = 50;

            // Hazne Duvarlarƒ±
            obstacles.push({ type: 'wall', x: centerX - gateW/2, y: gateTopY, w: 8, h: gateH, color: '#64748b' });
            obstacles.push({ type: 'wall', x: centerX + gateW/2 - 8, y: gateTopY, w: 8, h: gateH, color: '#64748b' });

            // Alt Kapak
            if (!lidOpen) {
                obstacles.push({ type: 'lid', x: centerX - gateW/2, y: gateTopY + gateH, w: gateW, h: 12, color: '#ef4444' });
            }

            // --- √áAPRAZ / STAGGERED √áƒ∞Vƒ∞ MANTIƒûI ---
            const startY = gateTopY + gateH + 50; 
            const endY = TRACK_HEIGHT - 60;
            const marbleDiameter = MARBLE_RADIUS * 2;
            
            // Satƒ±rlar arasƒ± dikey mesafe (Biraz artƒ±rƒ±ldƒ± ki bilyeler sƒ±kƒ±≈ümasƒ±n)
            const rowSpacing = marbleDiameter * 3; 
            
            let rowIndex = 0;

            for (let currentY = startY; currentY < endY; currentY += rowSpacing) {
                // ≈ûa≈üƒ±rtmalƒ± Sƒ±ralama: Tek numaralƒ± satƒ±rlarƒ± saƒüa kaydƒ±r
                // Bu, bilyelerin d√ºz deƒüil √ßapraz d√º≈ümesini saƒülar (Diagonal Akƒ±≈ü)
                const isOddRow = rowIndex % 2 !== 0;
                const staggerOffset = isOddRow ? (marbleDiameter * 2) : 0;

                // Satƒ±r ba≈ülangƒ±cƒ±
                let currentX = WALL_THICKNESS + 20 + staggerOffset;
                
                // Satƒ±rƒ±n sonuna kadar √ßivi d√∂≈üe
                while (currentX < TRACK_WIDTH - WALL_THICKNESS - 20) {
                    
                    // Rastgele Mesafe (1.2x ile 1.8x arasƒ±) - Biraz daha a√ßtƒ±k
                    const randomGapFactor = 1.2 + (Math.random() * 0.6);
                    const gap = marbleDiameter * randomGapFactor;

                    // Y Pozisyonunda hafif oynama (Dalgalƒ± satƒ±r etkisi i√ßin)
                    const jitterY = (Math.random() * 10) - 5;

                    obstacles.push({ 
                        type: 'circle', 
                        x: currentX, 
                        y: currentY + jitterY, 
                        r: PEG_RADIUS, 
                        color: '#64748b' 
                    });

                    // Bir sonraki konumu belirle
                    currentX += (PEG_RADIUS * 2) + gap;
                }
                rowIndex++;
            }

            // Ana Duvarlar
            obstacles.push({ type: 'wall', x: 0, y: 0, w: WALL_THICKNESS, h: TRACK_HEIGHT, color: '#1e293b' }); // Sol
            obstacles.push({ type: 'wall', x: TRACK_WIDTH - WALL_THICKNESS, y: 0, w: WALL_THICKNESS, h: TRACK_HEIGHT, color: '#1e293b' }); // Saƒü
        }

        function initMarbles() {
            const gateW = 140;
            const centerX = TRACK_WIDTH / 2;
            const startY = 60;

            marbles = racers.map((r, i) => ({
                ...r,
                x: centerX - gateW/2 + 20 + Math.random() * (gateW - 40),
                y: startY + Math.random() * 80,
                vx: (Math.random() - 0.5) * 2,
                vy: (Math.random() - 0.5) * 2,
                r: MARBLE_RADIUS,
                finished: false
            }));
            finishOrder = [];
        }

        // --- GAME CONTROL ---
        function startRace() {
            selectedMode = document.getElementById('gameMode').value;
            lidOpen = false;

            document.getElementById('setupView').style.display = 'none';
            const gameContainer = document.getElementById('gameContainer');
            gameContainer.classList.remove('hidden');
            gameContainer.style.display = 'flex';
            
            if (window.innerWidth < 768) {
                document.getElementById('mobileLeaderboard').classList.remove('hidden');
            }

            const modal = document.getElementById('resultModal');
            modal.style.display = 'none';
            modal.style.opacity = '0';

            const container = document.getElementById('raceCanvas').parentElement;
            const rect = container.getBoundingClientRect();
            
            TRACK_WIDTH = rect.width;
            TRACK_HEIGHT = rect.height;
            
            const dpr = window.devicePixelRatio || 1;
            canvas.width = TRACK_WIDTH * dpr;
            canvas.height = TRACK_HEIGHT * dpr;
            ctx.scale(dpr, dpr);
            
            initMarbles();
            generateMap(); 
            
            isRacing = true;
            if (animationId) cancelAnimationFrame(animationId);
            gameLoop();

            setTimeout(() => {
                lidOpen = true;
                generateMap(); 
            }, 1000);
        }

        function stopRace() {
            isRacing = false;
            cancelAnimationFrame(animationId);
            
            document.getElementById('setupView').style.display = 'flex';
            document.getElementById('gameContainer').style.display = 'none';
            document.getElementById('mobileLeaderboard').classList.add('hidden');
            document.getElementById('resultModal').style.display = 'none';
        }

        // --- PHYSICS LOOP ---
        function gameLoop() {
            if (!isRacing) return;

            marbles.forEach(m => {
                if (!m.finished) {
                    m.vy += GRAVITY;
                    m.vx *= FRICTION;
                    m.vy *= FRICTION;
                    m.x += m.vx;
                    m.y += m.vy;
                    
                    if (m.x < m.r + WALL_THICKNESS) { m.x = m.r + WALL_THICKNESS; m.vx *= -0.5; }
                    if (m.x > TRACK_WIDTH - m.r - WALL_THICKNESS) { m.x = TRACK_WIDTH - m.r - WALL_THICKNESS; m.vx *= -0.5; }
                }
            });

            // Collisions
            for (let i = 0; i < marbles.length; i++) {
                for (let j = i + 1; j < marbles.length; j++) {
                    const m1 = marbles[i];
                    const m2 = marbles[j];
                    const dx = m2.x - m1.x;
                    const dy = m2.y - m1.y;
                    const distSq = dx*dx + dy*dy;
                    const radSum = m1.r + m2.r;

                    if (distSq < radSum * radSum && distSq > 0) {
                        const dist = Math.sqrt(distSq);
                        const nx = dx / dist; const ny = dy / dist;
                        const overlap = (radSum - dist) * 0.5;

                        if (!m1.finished) { m1.x -= nx*overlap; m1.y -= ny*overlap; }
                        if (!m2.finished) { m2.x += nx*overlap; m2.y += ny*overlap; }

                        const p = 2 * (m1.vx * nx + m1.vy * ny - m2.vx * nx - m2.vy * ny) / 2;
                        m1.vx -= p * nx * 0.5; m1.vy -= p * ny * 0.5;
                        m2.vx += p * nx * 0.5; m2.vy += p * ny * 0.5;
                    }
                }
            }

            // Obstacles
            marbles.forEach(m => {
                if (m.finished) return;
                
                if (m.y >= TRACK_HEIGHT + m.r) {
                    m.finished = true;
                    finishOrder.push(m);
                    return;
                }

                obstacles.forEach(obs => {
                    if (obs.type === 'circle') {
                        const dx = m.x - obs.x;
                        const dy = m.y - obs.y;
                        const distSq = dx*dx + dy*dy;
                        const radSum = m.r + obs.r;
                        if (distSq < radSum * radSum) {
                            const dist = Math.sqrt(distSq);
                            const nx = dx / dist; const ny = dy / dist;
                            const overlap = radSum - dist;
                            m.x += nx * overlap; m.y += ny * overlap;
                            const dot = m.vx * nx + m.vy * ny;
                            m.vx = (m.vx - 2 * dot * nx) * BOUNCE;
                            m.vy = (m.vy - 2 * dot * ny) * BOUNCE;
                            m.vx += (Math.random() - 0.5) * 1.5;
                        }
                    } else { // Wall & Lid
                        if (m.x + m.r > obs.x && m.x - m.r < obs.x + obs.w &&
                            m.y + m.r > obs.y && m.y - m.r < obs.y + obs.h) {
                            
                            const overlapL = (m.x + m.r) - obs.x;
                            const overlapR = (obs.x + obs.w) - (m.x - m.r);
                            const overlapT = (m.y + m.r) - obs.y;
                            const overlapB = (obs.y + obs.h) - (m.y - m.r);
                            const min = Math.min(overlapL, overlapR, overlapT, overlapB);

                            if (min === overlapL) { m.x -= overlapL; m.vx *= -BOUNCE; }
                            else if (min === overlapR) { m.x += overlapR; m.vx *= -BOUNCE; }
                            else if (min === overlapT) { m.y -= overlapT; m.vy *= -BOUNCE; }
                            else if (min === overlapB) { m.y += overlapB; m.vy *= -BOUNCE; }
                        }
                    }
                });
            });

            // Draw
            ctx.clearRect(0, 0, TRACK_WIDTH, TRACK_HEIGHT);

            obstacles.forEach(obs => {
                ctx.fillStyle = obs.color || '#334155';
                if (obs.type === 'circle') {
                    ctx.beginPath();
                    ctx.arc(obs.x, obs.y, obs.r, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.shadowColor = 'rgba(255,255,255,0.1)';
                    ctx.shadowBlur = 5;
                    ctx.shadowOffsetX = 0; ctx.shadowOffsetY = 0;
                } else {
                    ctx.shadowColor = 'transparent';
                    ctx.fillRect(obs.x, obs.y, obs.w, obs.h);
                }
                ctx.shadowBlur = 0;
            });

            marbles.forEach(m => {
                if (m.finished) return;
                ctx.save();
                ctx.translate(m.x, m.y);
                
                const grad = ctx.createRadialGradient(-2, -2, 1, 0, 0, m.r);
                grad.addColorStop(0, '#fff');
                grad.addColorStop(0.3, m.color);
                grad.addColorStop(1, m.color);
                
                ctx.fillStyle = grad;
                ctx.beginPath(); ctx.arc(0, 0, m.r, 0, Math.PI * 2); ctx.fill();
                
                ctx.fillStyle = 'white'; ctx.font = 'bold 9px Fredoka'; ctx.textAlign = 'center'; 
                ctx.fillText(m.name.substring(0, 4), 0, -10);
                
                ctx.restore();
            });

            updateLiveLeaderboard(); // CANLI G√úNCELLEME
            checkFinishConditions();
            animationId = requestAnimationFrame(gameLoop);
        }

        function checkFinishConditions() {
            if (finishOrder.length === 0) return;
            
            let done = false;
            if (selectedMode === 'first' && finishOrder.length >= 1) done = true;
            else if (selectedMode === 'top3' && (finishOrder.length >= 3 || finishOrder.length === racers.length)) done = true;
            else if (selectedMode === 'all' && finishOrder.length === racers.length) done = true;

            if (done) {
                isRacing = false;
                setTimeout(showWinner, 600);
            }
        }

        // --- LIVE LEADERBOARD (CANLI SIRALAMA) ---
        function updateLiveLeaderboard() {
            const listDesktop = document.getElementById('liveLeaderboard');
            const listMobile = document.getElementById('mobileLeaderboardContent');
            let html = '';
            
            const sorted = [];
            
            // Bitenler
            finishOrder.forEach((m, i) => sorted.push({ ...m, rank: i + 1, done: true }));
            
            // Yarƒ±≈üanlar (Y koordinatƒ±na g√∂re sƒ±rala)
            const activeMarbles = marbles.filter(m => !m.finished).sort((a,b) => b.y - a.y);
            
            activeMarbles.forEach((m, i) => {
                sorted.push({ ...m, rank: finishOrder.length + i + 1, done: false });
            });

            // HTML Olu≈ütur
            sorted.forEach(m => {
                const style = m.done ? 'bg-yellow-500/10 border-yellow-500/40 text-yellow-100' : 'bg-white/5 border-white/5 text-slate-300';
                const icon = m.done ? (m.rank === 1 ? 'ü•á' : (m.rank===2 ? 'ü•à' : (m.rank===3 ? 'ü•â' : '‚úì'))) : '';
                
                html += `<div class="flex items-center p-2 rounded-lg border ${style} backdrop-blur-sm mb-1.5 transition-all duration-300">
                    <span class="font-bold w-6 text-center ${m.done ? 'text-yellow-400' : 'text-slate-500'} text-xs">#${m.rank}</span>
                    <div class="w-2.5 h-2.5 rounded-full shrink-0 mx-2 shadow-sm" style="background:${m.color}; box-shadow: 0 0 6px ${m.color}"></div>
                    <span class="truncate flex-1 text-xs font-semibold tracking-wide">${m.name}</span>
                    <span class="text-xs">${icon}</span>
                </div>`;
            });

            if(listDesktop) listDesktop.innerHTML = html;
            if(listMobile) listMobile.innerHTML = html;
        }

        function showWinner() {
            const modal = document.getElementById('resultModal');
            const winner = finishOrder[0];
            document.getElementById('winnerText').innerText = winner.name;
            document.getElementById('winnerText').style.color = winner.color;
            
            modal.style.display = 'flex';
            setTimeout(() => modal.style.opacity = '1', 50);
        }

        loadRacers();
    </script>
</body>
</html>