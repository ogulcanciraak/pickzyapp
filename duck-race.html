<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>rdek Yar覺覺 - Karar Verici</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600;700&family=VT323&display=swap" rel="stylesheet">

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Fredoka', 'sans-serif'],
              digital: ['VT323', 'monospace'],
            },
            animation: {
              'wobble': 'wobble 1s ease-in-out infinite',
              'bounce-slow': 'bounce 3s infinite',
              'wave': 'wave 3s cubic-bezier( 0.36, 0.45, 0.63, 0.53) infinite',
              'fadeIn': 'fadeIn 0.2s ease-out',
              'swim': 'swim 1.5s ease-in-out infinite',
              'boost': 'boost 0.4s ease-in-out infinite',
            },
            keyframes: {
              wobble: { '0%, 100%': { transform: 'rotate(-3deg)' }, '50%': { transform: 'rotate(3deg)' } },
              wave: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-5px)' } },
              swim: { '0%, 100%': { transform: 'translateY(0) rotate(0deg)' }, '50%': { transform: 'translateY(-6px) rotate(3deg)' } },
              boost: { '0%, 100%': { transform: 'scale(1) skew(0deg)' }, '50%': { transform: 'scale(1.1) skew(-5deg)' } },
              fadeIn: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } }
            },
          },
        },
      }
    </script>
</head>
<body class="bg-sky-300">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;
      const e = React.createElement;

      // --- SVG ICONS (Lucide React yerine Inline SVG) ---
      const Icons = {
        Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
        X: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>,
        Play: () => <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
        Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
        Clock: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
        Zap: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
        RotateCcw: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>,
        Home: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
        Trophy: () => <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>,
        Volume2: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>,
        VolumeX: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" x2="17" y1="9" y2="15"/><line x1="17" x2="23" y1="9" y2="15"/></svg>,
        Shuffle: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 3h5v5"/><path d="M4 20L21 3"/><path d="M21 16v5h-5"/><path d="M15 15l6 6"/><path d="M4 4l5 5"/></svg>
      };

      const DUCK_COLORS = [
        { bg: 'bg-red-500', border: 'border-red-700', text: 'text-white' },
        { bg: 'bg-orange-500', border: 'border-orange-700', text: 'text-white' },
        { bg: 'bg-yellow-400', border: 'border-yellow-600', text: 'text-black' },
        { bg: 'bg-green-500', border: 'border-green-700', text: 'text-white' },
        { bg: 'bg-teal-500', border: 'border-teal-700', text: 'text-white' },
        { bg: 'bg-cyan-500', border: 'border-cyan-700', text: 'text-white' },
        { bg: 'bg-blue-500', border: 'border-blue-700', text: 'text-white' },
        { bg: 'bg-indigo-500', border: 'border-indigo-700', text: 'text-white' },
        { bg: 'bg-purple-500', border: 'border-purple-700', text: 'text-white' },
        { bg: 'bg-pink-500', border: 'border-pink-700', text: 'text-white' },
      ];

      const generateUniqueDuckSvg = () => {
        const colors = ['#facc15', '#fbbf24', '#fde047', '#ffffff', '#a8a29e', '#57534e']; 
        const beakColors = ['#f97316', '#ea580c', '#fb923c'];
        const bodyColor = colors[Math.floor(Math.random() * colors.length)];
        const beakColor = beakColors[Math.floor(Math.random() * beakColors.length)];
        
        const hatType = Math.random() > 0.3 ? Math.floor(Math.random() * 5) : 0;
        const hasGlasses = Math.random() > 0.8;

        let accessorySvg = '';

        if (hatType === 1) accessorySvg += `<rect x="35" y="5" width="30" height="25" fill="#1e293b" /><rect x="25" y="30" width="50" height="5" fill="#1e293b" /><rect x="35" y="25" width="30" height="5" fill="#ef4444" />`;
        else if (hatType === 2) accessorySvg += `<path d="M30 30 Q30 10 70 30 L70 35 L30 35 Z" fill="#2563eb" /><rect x="65" y="30" width="20" height="5" fill="#2563eb" />`;
        else if (hatType === 3) accessorySvg += `<ellipse cx="50" cy="25" rx="35" ry="10" fill="#78350f" /><path d="M35 25 Q50 5 65 25" fill="#92400e" stroke="#78350f" stroke-width="2"/>`;
        else if (hatType === 4) accessorySvg += `<path d="M30 30 L30 15 L40 25 L50 10 L60 25 L70 15 L70 30 Z" fill="#fbbf24" stroke="#b45309" stroke-width="2" />`;

        if (hasGlasses) accessorySvg += `<circle cx="65" cy="45" r="6" fill="black" /><circle cx="80" cy="45" r="6" fill="black" /><line x1="71" y1="45" x2="74" y2="45" stroke="black" stroke-width="2" />`;
        else accessorySvg += `<circle cx="70" cy="45" r="5" fill="white" /><circle cx="72" cy="45" r="2" fill="black" />`;

        const svgString = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
            <path d="M20 60 Q10 80 40 90 L80 90 Q95 80 90 60 Q85 40 60 40 L60 60 Z" fill="${bodyColor}" />
            <circle cx="60" cy="40" r="25" fill="${bodyColor}" />
            <path d="M35 65 Q45 85 65 65" fill="none" stroke="${bodyColor === '#ffffff' ? '#e5e5e5' : '#ca8a04'}" stroke-width="3" />
            <path d="M80 45 Q95 40 95 50 Q90 60 80 55 Z" fill="${beakColor}" />
            ${accessorySvg}
          </svg>
        `;
        return `data:image/svg+xml;base64,${btoa(svgString)}`;
      };

      const SetupScreen = ({ ducks, onAdd, onRemove, onClear, onStart, raceDuration, setRaceDuration }) => {
        const [inputValue, setInputValue] = useState('');

        const handleSubmit = (event) => {
          event.preventDefault();
          if (inputValue.trim()) {
              if(ducks.length >= 50) return alert("Maksimum 50 繹rdek yar覺t覺rabilirsiniz!");
              onAdd(inputValue);
              setInputValue('');
          }
        };

        const getColor = (jsonStr) => {
          try { return JSON.parse(jsonStr); } catch { return { bg: 'bg-gray-500', text: 'text-white' }; }
        };

        return (
            <div className="w-full max-w-lg mx-4 flex flex-col max-h-[90vh]">
            <div className="bg-white rounded-xl shadow-2xl overflow-hidden border-4 border-slate-800 flex flex-col h-full">
              <div className="bg-slate-800 p-4 text-center flex justify-between items-center">
                  <h2 className="text-2xl font-black text-white tracking-wide uppercase flex-1">Yar覺癟覺lar</h2>
                  {ducks.length > 0 && <button onClick={onClear} title="T羹m羹n羹 Temizle" className="bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg transition-colors"><Icons.Trash2 /></button>}
              </div>

              <div className="p-6 bg-slate-100 flex-1 flex flex-col min-h-0">
                  <div className="mb-4 bg-white p-3 rounded-lg shadow-sm border border-slate-200">
                      <div className="flex items-center justify-between mb-2">
                          <div className="flex items-center gap-2 text-slate-700 font-bold"><Icons.Clock /><span>S羹re: {raceDuration} sn</span></div>
                      </div>
                      <input type="range" min="5" max="60" step="5" value={raceDuration} onChange={(ev) => setRaceDuration(Number(ev.target.value))} className="w-full accent-blue-500 cursor-pointer h-2 bg-slate-200 rounded-lg appearance-none" />
                      <div className="flex justify-between text-xs text-slate-400 mt-1 font-mono"><span>H覺zl覺 (5s)</span><span>Uzun (60s)</span></div>
                  </div>

                  <form onSubmit={handleSubmit} className="flex gap-2 mb-4 shrink-0">
                      <input type="text" value={inputValue} onChange={(ev) => setInputValue(ev.target.value)} placeholder="襤sim girin..." className="flex-1 border-2 border-slate-300 rounded-lg px-4 py-3 text-lg focus:border-blue-500 focus:outline-none shadow-inner" autoFocus />
                      <button type="submit" disabled={!inputValue.trim()} className="bg-green-500 hover:bg-green-600 disabled:bg-slate-300 text-white rounded-lg px-4 border-b-4 border-green-700 active:border-b-0 active:translate-y-1 transition-all"><Icons.Plus /></button>
                  </form>

                  <div className="space-y-2 overflow-y-auto custom-scrollbar pr-2 mb-4 flex-1">
                      {ducks.length === 0 && <div className="text-center text-slate-400 italic py-8 flex flex-col items-center"><span className="text-4xl mb-2"></span><p>Hen羹z kimse eklenmedi.</p></div>}
                      {ducks.map((duck, index) => {
                          const colors = getColor(duck.color);
                          return (
                             <div key={duck.id} className="flex items-center bg-white p-2 rounded-lg border-2 border-slate-200 shadow-sm animate-[fadeIn_0.2s_ease-out]">
                                  <div className={`w-8 h-8 rounded-full ${colors.bg} flex items-center justify-center text-white font-bold mr-3 border border-black/10 shrink-0`}>{index + 1}</div>
                                  <span className="flex-1 font-bold text-slate-700 text-lg truncate">{duck.name}</span>
                                  <button onClick={() => onRemove(duck.id)} className="text-slate-300 hover:text-red-500 transition-colors p-2 shrink-0"><Icons.X /></button>
                             </div>
                          );
                      })}
                  </div>

                  <button onClick={onStart} disabled={ducks.length < 2} className="w-full shrink-0 bg-blue-500 hover:bg-blue-600 disabled:bg-slate-400 disabled:cursor-not-allowed text-white text-2xl font-black py-4 rounded-xl border-b-8 border-blue-700 active:border-b-0 active:translate-y-2 transition-all flex items-center justify-center gap-3">
                    <Icons.Play /> BALAT
                  </button>
              </div>
            </div>
            </div>
        );
      };

      const Bush = ({ className }) => (
          <svg viewBox="0 0 100 60" className={className} fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M10 50C10 50 0 40 10 30C20 20 20 10 40 10C60 10 70 20 80 20C90 20 100 40 90 50" stroke="#15803d" strokeWidth="3" strokeLinecap="round" />
            <path d="M20 50C20 50 15 35 30 30" stroke="#15803d" strokeWidth="2" strokeLinecap="round" />
            <path d="M70 50C70 50 75 35 60 30" stroke="#15803d" strokeWidth="2" strokeLinecap="round" />
          </svg>
      );

      const RaceTrack = ({ ducks }) => {
        const getColor = (jsonStr) => { try { return JSON.parse(jsonStr); } catch { return { bg: 'bg-gray-500', border: 'border-gray-600', text: 'text-white' }; } };
        const count = ducks.length;
        const calculateRowHeight = () => {
          if (count <= 3) return 'h-40';
          if (count <= 6) return 'h-32';
          if (count <= 10) return 'h-24';
          if (count <= 20) return 'h-16';
          return 'h-full'; 
        };
        const rowHeightClass = calculateRowHeight();
        const isCrowded = count > 10;
        const isVeryCrowded = count > 25;

        return (
             <div className="absolute inset-0 flex flex-col bg-[#2d88a4]">
                  <div className="absolute inset-0 pointer-events-none z-0 flex flex-col">
                      <div className="h-[20%] bg-[#22c55e] relative shadow-lg shrink-0">
                          <Bush className="absolute bottom-2 left-[5%] w-16 h-10 opacity-80" />
                          <Bush className="absolute bottom-6 left-[45%] w-12 h-8 opacity-60" />
                          <Bush className="absolute bottom-4 right-[10%] w-20 h-12 opacity-80" />
                          <div className="absolute bottom-8 left-[20%] text-green-700 font-bold opacity-40">w</div>
                          <div className="absolute bottom-4 right-[30%] text-green-700 font-bold opacity-40">w</div>
                          <div className="absolute bottom-0 w-full h-4 bg-[#784f32]">
                              <div className="absolute -top-1 left-0 w-full h-2 bg-[#784f32] [clip-path:polygon(0%_100%,_10%_0%,_20%_100%,_30%_10%,_40%_100%,_50%_0%,_60%_100%,_70%_0%,_80%_100%,_90%_0%,_100%_100%)] opacity-50"></div>
                          </div>
                      </div>
                      <div className="flex-1 bg-[#2686a0] relative overflow-hidden">
                          <div className="w-[120%] h-24 bg-[#1f728a] absolute top-[10%] -left-10 -rotate-1 opacity-80 rounded-[50%] blur-sm"></div>
                          <div className="w-[120%] h-24 bg-[#1b657d] absolute top-[30%] -left-10 rotate-1 opacity-80 rounded-[50%] blur-sm"></div>
                          <div className="w-[120%] h-24 bg-[#185a70] absolute top-[50%] -left-10 -rotate-1 opacity-80 rounded-[50%] blur-sm"></div>
                          <div className="w-[120%] h-24 bg-[#144f63] absolute top-[70%] -left-10 rotate-1 opacity-80 rounded-[50%] blur-sm"></div>
                          <div className="w-[120%] h-24 bg-[#104557] absolute top-[90%] -left-10 -rotate-1 opacity-80 rounded-[50%] blur-sm"></div>
                      </div>
                  </div>

                  <div className="absolute inset-0 z-20 flex flex-col h-full">
                      <div className="h-[20%] w-full flex-shrink-0 pointer-events-none"></div>
                      <div className="flex-1 relative w-full h-full flex flex-col justify-center">
                          <div className="absolute top-0 bottom-0 right-[10%] w-[5vw] z-0 flex flex-col border-l-4 border-r-4 border-white/30 h-full">
                              <div className="w-full h-full opacity-90" style={{backgroundImage: `linear-gradient(45deg, #000 25%, transparent 25%), linear-gradient(-45deg, #000 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #000 75%), linear-gradient(-45deg, transparent 75%, #000 75%)`, backgroundColor: 'white', backgroundSize: '30px 30px', backgroundPosition: '0 0, 0 15px, 15px -15px, -15px 0px'}}></div>
                          </div>

                          <div className={`w-full relative flex flex-col ${count > 20 ? 'h-full' : ''}`}>
                              {ducks.map((duck, index) => {
                                  const colors = getColor(duck.color);
                                  return (
                                      <div key={duck.id} className={`relative w-full flex items-center shrink-0 border-b border-black/5 last:border-0 ${rowHeightClass}`} style={isVeryCrowded ? { flex: 1, maxHeight: '60px' } : {}}>
                                          <div className="absolute top-1/2 -translate-y-1/2 z-20" style={{ left: `calc(${duck.progress * 0.8}% + 10px)`, zIndex: 100 + index, height: isCrowded ? '140%' : '85%', width: 'auto', aspectRatio: '1/1', transition: 'left 0.3s ease-out' }}>
                                              <div className="relative group w-full h-full">
                                                  <div className={`absolute left-1/2 -translate-x-1/2 bg-white border-2 border-black px-4 py-2 rounded-lg shadow-sm whitespace-nowrap z-50 transition-transform origin-bottom ${isCrowded ? '-top-[60%] scale-75' : '-top-16'}`}>
                                                      <p className={`relative z-10 font-black text-black font-sans leading-none tracking-tight ${isCrowded ? 'text-xs' : 'text-sm md:text-base'}`}>{duck.name}</p>
                                                      <div className="absolute left-1/2 -bottom-2 -translate-x-1/2 w-0 h-0 border-l-[8px] border-l-transparent border-r-[8px] border-r-transparent border-t-[8px] border-t-black"></div>
                                                      <div className="absolute left-1/2 -bottom-[5px] -translate-x-1/2 w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent border-t-[6px] border-t-white"></div>
                                                  </div>

                                                  <div className={`relative w-full h-full animate-swim`}>
                                                      <img src={duck.avatarUrl} alt="Duck" className="w-full h-full object-contain drop-shadow-md select-none" draggable={false} />
                                                      {!isCrowded && <div className={`absolute top-[60%] left-[10%] w-[30%] h-[30%] rounded-full ${colors.bg} ${colors.border} border flex items-center justify-center shadow-sm transform -translate-y-1/2`}><span className="text-[60%] font-black text-white leading-none">{index + 1}</span></div>}
                                                      {duck.rank && <div className="absolute -right-[10%] -top-[10%] bg-yellow-400 text-yellow-900 border-2 border-white w-[40%] h-[40%] rounded-full flex items-center justify-center font-black text-[70%] shadow-lg animate-bounce z-40">#{duck.rank}</div>}
                                                  </div>
                                              </div>
                                          </div>
                                      </div>
                                  );
                              })}
                          </div>
                      </div>
                  </div>
             </div>
        );
      };

      const WinnerModal = ({ winner, timer, onRestart, onReset }) => {
        const [show, setShow] = useState(false);
        const colors = JSON.parse(winner.color);
        useEffect(() => { setShow(true); }, []);

        return (
            <div className={`fixed inset-0 z-[100] flex items-center justify-center p-4 transition-all duration-500 ${show ? 'bg-black/70 backdrop-blur-sm' : 'bg-transparent pointer-events-none opacity-0'}`}>
            <div className={`bg-white rounded-3xl shadow-2xl max-w-sm w-full p-6 text-center transform transition-all duration-500 border-8 border-yellow-400 ${show ? 'scale-100 translate-y-0' : 'scale-50 translate-y-20'}`}>
              <div className="absolute -top-16 left-1/2 -translate-x-1/2">
                   <div className="bg-yellow-400 p-4 rounded-full shadow-lg border-4 border-white inline-block">
                      <Icons.Trophy />
                   </div>
              </div>
              <div className="mt-8">
                  <h2 className="text-4xl font-black text-slate-800 mb-1 uppercase tracking-tight">Kazanan</h2>
                  <div className="my-6 relative inline-block">
                      <img src={winner.avatarUrl} alt="Winner" className="w-32 h-32 object-contain animate-bounce-slow" />
                      <div className="absolute -bottom-2 right-0 bg-yellow-400 text-yellow-900 font-bold px-3 py-1 rounded-full border-2 border-white shadow-sm">#1</div>
                  </div>
                  <div className={`text-3xl font-bold ${colors.text.replace('text-white', 'text-blue-600')} mb-4`}>{winner.name}</div>
                  <div className="flex items-center justify-center gap-2 text-slate-500 font-mono text-xl bg-slate-100 py-2 rounded-lg mb-6 mx-4"><Icons.Clock />{timer}</div>
                  <div className="grid grid-cols-2 gap-3">
                      <button onClick={onRestart} className="flex flex-col items-center justify-center py-3 rounded-xl bg-blue-100 text-blue-600 hover:bg-blue-200 hover:scale-105 transition-all font-bold border-b-4 border-blue-300 active:border-b-0 active:translate-y-1"><Icons.RotateCcw /><span className="mt-1">Tekrar</span></button>
                      <button onClick={onReset} className="flex flex-col items-center justify-center py-3 rounded-xl bg-slate-100 text-slate-600 hover:bg-slate-200 hover:scale-105 transition-all font-bold border-b-4 border-slate-300 active:border-b-0 active:translate-y-1"><Icons.Home /><span className="mt-1">Men羹</span></button>
                  </div>
              </div>
            </div>
            </div>
        );
      };

      const App = () => {
        const [gameState, setGameState] = useState('setup');
        const [ducks, setDucks] = useState([]);
        const [winner, setWinner] = useState(null);
        const [timer, setTimer] = useState(0);
        const [isMuted, setIsMuted] = useState(false);
        const [raceDuration, setRaceDuration] = useState(10);
        
        const requestRef = useRef(null);
        const previousTimeRef = useRef(0);
        const startTimeRef = useRef(0);
        const isRacingRef = useRef(false);

        // LocalStorage Logic
        useEffect(() => {
            const saved = localStorage.getItem('duck_racers');
            if (saved) {
                setDucks(JSON.parse(saved));
            } else {
                const initialNames = ['Rory', 'Ilia', 'Rozalyn', 'George', 'Ian'];
                setDucks(initialNames.map((name, idx) => ({
                    id: Math.random().toString(36).substr(2, 9),
                    name,
                    color: JSON.stringify(DUCK_COLORS[idx % DUCK_COLORS.length]),
                    avatarUrl: generateUniqueDuckSvg(),
                    progress: 0,
                    speed: 0,
                    state: 'idle',
                    waddleOffset: Math.random() * 100,
                    speedMod: 1.0, 
                    targetSpeedMod: 1.0 
                })));
            }
        }, []);

        useEffect(() => {
            if (ducks.length > 0) localStorage.setItem('duck_racers', JSON.stringify(ducks));
        }, [ducks]);

        const handleAddDuck = (name) => {
          if (!name.trim()) return;
          setDucks(prev => [...prev, {
              id: Math.random().toString(36).substr(2, 9),
              name: name.trim(),
              color: JSON.stringify(DUCK_COLORS[prev.length % DUCK_COLORS.length]),
              avatarUrl: generateUniqueDuckSvg(),
              progress: 0,
              speed: 0,
              state: 'idle',
              waddleOffset: Math.random() * 100,
              speedMod: 1.0,
              targetSpeedMod: 1.0
          }]);
        };

        const handleRemoveDuck = (id) => setDucks(prev => prev.filter(d => d.id !== id));

        const handleClearDucks = () => {
          if (confirm('T羹m listeyi silmek istediinize emin misiniz?')) {
              setDucks([]);
              localStorage.removeItem('duck_racers');
          }
        };

        const handleShuffle = () => {
          setDucks(prev => {
              const shuffled = [...prev];
              for (let i = shuffled.length - 1; i > 0; i--) {
                  const j = Math.floor(Math.random() * (i + 1));
                  [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
              }
              return shuffled.map((d, idx) => ({ ...d, color: JSON.stringify(DUCK_COLORS[idx % DUCK_COLORS.length]), avatarUrl: generateUniqueDuckSvg() }));
          });
        };

        const startRace = () => {
          if (ducks.length < 2) return;
          setDucks(prev => prev.map(d => ({ ...d, progress: 0, speed: 0, rank: undefined, state: 'idle', reactionTime: Math.random() * 800, speedMod: 0.9 + Math.random() * 0.2, targetSpeedMod: 1.0 })));
          setWinner(null);
          setTimer(0);
          setGameState('racing');
          isRacingRef.current = true;
          startTimeRef.current = Date.now();
          previousTimeRef.current = Date.now();
          requestRef.current = requestAnimationFrame(animateRace);
        };

        const resetGame = () => {
          isRacingRef.current = false;
          if (requestRef.current) cancelAnimationFrame(requestRef.current);
          setGameState('setup');
          setWinner(null);
          setTimer(0);
          setDucks(prev => prev.map(d => ({ ...d, progress: 0, speed: 0, rank: undefined, state: 'idle' })));
        };

        const restartRace = () => startRace();

        const formatTime = (ms) => {
          const minutes = Math.floor(ms / 60000);
          const seconds = Math.floor((ms % 60000) / 1000);
          const centiseconds = Math.floor((ms % 1000) / 10);
          return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}:${centiseconds.toString().padStart(2, '0')}`;
        };

        const animateRace = (time) => {
          if (!isRacingRef.current) return;
          const currentTime = Date.now();
          const elapsedTime = currentTime - startTimeRef.current;
          const deltaTime = Math.min(currentTime - previousTimeRef.current, 50); 
          previousTimeRef.current = currentTime;
          setTimer(elapsedTime);

          setDucks(prevDucks => {
            let raceFinished = false;
            let currentWinner = null;
            const maxProgress = Math.max(...prevDucks.map(d => d.progress));

            const updatedDucks = prevDucks.map(duck => {
              if (duck.rank) return duck;
              if (elapsedTime < duck.reactionTime) return duck;
              let newDuck = { ...duck };
              if (Math.random() < 0.02) newDuck.targetSpeedMod = 0.8 + Math.random() * 0.4;
              newDuck.speedMod += (newDuck.targetSpeedMod - newDuck.speedMod) * 0.02;
              const idealVelocityPerMs = 105 / ((raceDuration * 1000) - 500); 
              const distanceToLeader = maxProgress - newDuck.progress;
              let rubberBandFactor = distanceToLeader > 0 ? 1 + (Math.min(distanceToLeader, 20) * 0.001) : 1.0;
              const waddle = Math.sin((currentTime / 600) + newDuck.waddleOffset) * 0.05; 
              const targetMultiplier = (newDuck.speedMod + waddle) * rubberBandFactor;
              const lerpFactor = 0.05;
              newDuck.speed = duck.speed + (targetMultiplier - duck.speed) * lerpFactor;
              const moveAmount = idealVelocityPerMs * newDuck.speed * deltaTime;
              newDuck.progress = duck.progress + moveAmount;
              newDuck.state = 'running';

              if (newDuck.progress >= 100) {
                  const finishedCount = prevDucks.filter(d => d.rank !== undefined).length;
                  const rank = finishedCount + 1;
                  if (rank === 1) { raceFinished = true; currentWinner = { ...newDuck, progress: 100, rank: 1 }; return currentWinner; }
                  return { ...newDuck, progress: 100, rank };
              }
              return newDuck;
            });

            if (raceFinished && currentWinner) {
              setWinner(currentWinner);
              setTimeout(() => {
                   isRacingRef.current = false;
                   if(requestRef.current) cancelAnimationFrame(requestRef.current);
                   setGameState('finished');
              }, 1000);
            }
            if (!updatedDucks.some(d => !d.rank)) {
               isRacingRef.current = false;
               if(requestRef.current) cancelAnimationFrame(requestRef.current);
               setGameState('finished');
            }
            return updatedDucks;
          });
          if (isRacingRef.current) requestRef.current = requestAnimationFrame(animateRace);
        };

        useEffect(() => {
          return () => {
            isRacingRef.current = false;
            if (requestRef.current) cancelAnimationFrame(requestRef.current);
          };
        }, []);

        return (
            <div className="h-screen w-full bg-sky-300 relative overflow-hidden flex flex-col font-sans">
              <div className="z-50 px-4 py-3 flex justify-between items-start bg-gradient-to-b from-black/40 to-transparent absolute top-0 w-full pointer-events-none h-24">
                  <div className="flex flex-col gap-2 pointer-events-auto">
                       <div className="flex gap-1">
                          <button onClick={() => setIsMuted(!isMuted)} className="bg-black/80 hover:bg-black text-white p-2 rounded border-2 border-white/20 transition-all">
                            {isMuted ? <Icons.VolumeX /> : <Icons.Volume2 />}
                          </button>
                       </div>
                       {gameState === 'setup' && <button onClick={handleShuffle} className="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm font-bold border-2 border-green-800 shadow-md flex items-center gap-2"><Icons.Shuffle /> Kar覺t覺r</button>}
                  </div>
                  <div className="bg-slate-200 border-4 border-slate-700 rounded-xl px-6 py-1 shadow-2xl transform translate-y-2">
                      <div className="font-digital text-6xl text-slate-900 tracking-widest leading-none">{formatTime(timer)}</div>
                  </div>
                  <div className="flex flex-col gap-2 pointer-events-auto items-end">
                      {gameState !== 'setup' && <button onClick={resetGame} className="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded border-b-4 border-red-700 active:border-b-0 active:translate-y-1 transition-all">Durdur / S覺f覺rla</button>}
                       {gameState === 'setup' && <div className="text-white font-bold drop-shadow-md text-right"><p className="text-2xl">HAZIRLIK</p><p className="text-sm opacity-80">{ducks.length} Yar覺mac覺</p></div>}
                  </div>
              </div>
              <div className="flex-1 relative z-0 h-full">
                    {gameState === 'setup' ? 
                      <div className="h-full flex items-center justify-center bg-black/20 backdrop-blur-sm pt-20">
                         <SetupScreen ducks={ducks} onAdd={handleAddDuck} onRemove={handleRemoveDuck} onClear={handleClearDucks} onStart={startRace} raceDuration={raceDuration} setRaceDuration={setRaceDuration} />
                      </div>
                    : <RaceTrack ducks={ducks} />
                    }
              </div>
              {gameState === 'finished' && winner && <WinnerModal winner={winner} onRestart={restartRace} onReset={resetGame} timer={formatTime(timer)} />}
            </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(e(React.StrictMode, null, e(App)));
    </script>
</body>
</html>